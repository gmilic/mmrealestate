<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Create and style clusters</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
      .mapboxgl-popup-content h3 {
        margin: 0 1rem;

        font-weight: 700;
      }
      .mapboxgl-popup-content > button {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script>
      mapboxgl.accessToken =
        'pk.eyJ1IjoibW1yZWFsZXN0YXRldGVjaCIsImEiOiJjbHF4c3B3YzAwMmppMnBsbDNwaHF6OTkzIn0.WBLKHqG7SqjsyYf1J1cGzQ'
      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mmrealestatetech/clq572q34004t01pq5pzd3x7d',
        center: [16.595359107299924, 44.69292792414397],
        zoom: 1
      })

      let mapLocations = {
        type: 'FeatureCollection',
        features: [
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [-101.77602138938106, 53.25942690963367]
            },
            properties: {
              id: 'Canada',
              description: 'Canada',
              images: [
                'https://picsum.photos/100/100',
                'https://picsum.photos/100/200'
              ]
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [-97.97984889957462, 39.56139894292898]
            },
            properties: {
              id: 'USA',
              description: 'USA',
              images: [
                'https://picsum.photos/100/100',
                'https://picsum.photos/100/150'
              ]
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [-102.21052155433465, 23.31332461125135]
            },
            properties: {
              id: 'Mexico',
              description: 'Mexico',
              images: ['https://picsum.photos/100/100']
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [-51.10016194263337, -8.442152813684823]
            },
            properties: {
              id: 'Brasil',
              description: 'Brasil',
              images: []
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [-70.49743389067524, -28.756877385591455]
            },
            properties: {
              id: 'Chile',
              description: 'Chile',
              images: []
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [-64.63174854428497, -34.319193672799976]
            },
            properties: {
              id: 'Argentina',
              description: 'Argentina',
              images: []
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [133.65771949467202, -23.85407424065941]
            },
            properties: {
              id: 'Australia',
              description: 'Australia',
              images: []
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [8.19827657800132, 9.299578037624402]
            },
            properties: {
              id: 'Nigeria',
              description: 'Nigeria',
              images: []
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [79.06942436676307, 22.209156843062033]
            },
            properties: {
              id: 'India',
              description: 'India',
              images: []
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [104.59864089763026, 33.80891705112426]
            },
            properties: {
              id: 'China',
              description: 'China',
              images: []
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [80.77834970326955, 61.94570894954663]
            },
            properties: {
              id: 'Rusia',
              description: 'Rusia',
              images: []
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [45.43370072705655, 23.325901489545288]
            },
            properties: {
              id: 'Saudi Arabia',
              description: 'Saudi Arabia',
              images: []
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [47.5344939775652, 29.436906383212115]
            },
            properties: {
              id: 'Kuwait',
              description: 'Kuwait',
              images: []
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [34.92189002801198, 31.070689810007156]
            },
            properties: {
              id: 'Israel',
              description: 'Israel',
              images: []
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [9.360595650234208, 34.230515974654]
            },
            properties: {
              id: 'Tunisia',
              description: 'Tunisia',
              images: []
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [-3.3161258968608425, 39.98506660779623]
            },
            properties: {
              id: 'Spain',
              description: 'Spain',
              images: []
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [12.11248023862823, 43.364372083537916]
            },
            properties: {
              id: 'Italia',
              description: 'Italia',
              images: []
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [2.5651663641661155, 46.82187808314933]
            },
            properties: {
              id: 'France',
              description: 'France',
              images: []
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [-1.4107946082531797, 53.12490536922027]
            },
            properties: {
              id: 'UK',
              description: 'UK',
              images: []
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [5.449302240096535, 52.32999355923622]
            },
            properties: {
              id: 'Netherlands',
              description: 'Netherlands',
              images: []
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [8.212791051008711, 46.99325062437521]
            },
            properties: {
              id: 'Switzerland',
              description: 'Switzerland',
              images: []
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [14.574844403804553, 47.59206393848699]
            },
            properties: {
              id: 'Austria',
              description: 'Austria',
              images: []
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [10.542056537900336, 55.39916636839304]
            },
            properties: {
              id: 'Denmark',
              description: 'Denmark',
              images: []
            }
          },
          {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [10.178360564243881, 50.95954972820095]
            },
            properties: {
              id: 'Germany',
              description: 'Germany',
              images: []
            }
          }
        ]
      }

      map.on('load', () => {
        map.addSource('clientsList', {
          type: 'geojson',

          data: mapLocations,
          cluster: true,
          clusterMaxZoom: 10, // Max zoom to cluster points on
          clusterRadius: 80 // Radius of each cluster when clustering points (defaults to 50)
        })

        map.addLayer({
          id: 'clusters',
          type: 'circle',
          source: 'clientsList',
          filter: ['has', 'point_count'],
          paint: {
            'circle-color': '#0072ce',
            'circle-radius': 20
          }
        })

        map.addLayer({
          id: 'cluster-count',
          type: 'symbol',
          source: 'clientsList',
          filter: ['has', 'point_count'],
          layout: {
            'text-field': ['get', 'point_count_abbreviated'],
            'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
            'text-size': 12
          }
        })

        map.addLayer({
          id: 'unclustered-point',
          type: 'circle',
          source: 'clientsList',
          filter: ['!', ['has', 'point_count']],
          paint: {
            'circle-color': '#0072ce',
            'circle-radius': 10,
            'circle-stroke-width': 4,
            'circle-stroke-color': '#00559b'
          }
        })

        map.on('click', 'clusters', (e) => {
          const features = map.queryRenderedFeatures(e.point, {
            layers: ['clusters']
          })
          const clusterId = features[0].properties.cluster_id
          map
            .getSource('clientsList')
            .getClusterExpansionZoom(clusterId, (err, zoom) => {
              if (err) return

              map.easeTo({
                center: features[0].geometry.coordinates,
                zoom: zoom
              })
            })
        })

        map.on('mouseenter', 'unclustered-point', (e) => {
          map.getCanvas().style.cursor = 'pointer'
          const coordinates = e.features[0].geometry.coordinates.slice()
          const name = e.features[0].properties.id
          while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360
          }
          const images = JSON.parse(e.features[0].properties.images)
          const imagesHtml = images
            .map(
              (image) =>
                `<img src="${image}" style="max-width: 100%; max-height: 200px; display: block"/>`
            )
            .join('')

          new mapboxgl.Popup()
            .setLngLat(coordinates)
            .setHTML(`<h3>${name}</h3>${imagesHtml}`)
            .addTo(map)
        })

        map.on('mouseleave', 'unclustered-point', () => {
          map.getCanvas().style.cursor = ''
          const popup = document.getElementsByClassName('mapboxgl-popup')
          if (popup.length) {
            popup[0].remove()
          }
        })

        map.on('mouseenter', 'clusters', () => {
          map.getCanvas().style.cursor = 'pointer'
        })
        map.on('mouseleave', 'clusters', () => {
          map.getCanvas().style.cursor = ''
        })
      })
    </script>
  </body>
</html>
